name: Code Coverage (lcov)

on:
  workflow_call:

jobs:
    coverage_report:
        name: Generate coverage report
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v3

        - name: Setup LCOV
          uses: hrishikesh-kadam/setup-lcov@v1

        - name: Run Coverage
          run: |
            cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCOVERAGE=ON -S .
            cmake --build build --target coverage

        - name: Report code coverage
          uses: zgosalvez/github-actions-report-lcov@v3
          with:
            coverage-files: build/coverage.info
            minimum-coverage: 15
            artifact-name: code-coverage-report
            github-token: ${{ secrets.GITHUB_TOKEN }}
            update-comment: true
            working-directory: src